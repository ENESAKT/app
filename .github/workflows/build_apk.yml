name: Build and Release APK

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.0.1 gibi version tag'lerinde tetiklenir
  workflow_dispatch: # Manuel tetikleme

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: ğŸ”§ Build APK
        working-directory: ./frontend
        run: flutter build apk --release --no-tree-shake-icons

      - name: ğŸ“‹ Get version info
        id: version
        run: |
          # Tag'den versiyon al (v1.0.1 -> 1.0.1)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## ğŸš€ Project-Friend v${{ steps.version.outputs.version }}
            
            ### ğŸ“± Uygulama GÃ¼ncellemesi
            **SÃ¼rÃ¼m:** ${{ steps.version.outputs.version }}  
            **Tarih:** ${{ steps.version.outputs.date }}  
            **Build:** #${{ github.run_number }}
            
            ### ğŸ“¥ Kurulum
            1. AÅŸaÄŸÄ±daki APK dosyasÄ±nÄ± indirin
            2. Telefonunuzda "Bilinmeyen Kaynaklardan Kurulum"u aktifleÅŸtirin
            3. APK'yÄ± aÃ§Ä±p kurun
            
            ### ğŸ”„ OTA GÃ¼ncelleme
            Bu sÃ¼rÃ¼m OTA gÃ¼ncelleme sistemi ile otomatik daÄŸÄ±tÄ±labilir.
            Supabase'de `app_versions` tablosuna aÅŸaÄŸÄ±daki kaydÄ± ekleyin:
            
            ```sql
            INSERT INTO app_versions (version_number, apk_url, force_update, update_message)
            VALUES (
              '${{ steps.version.outputs.version }}',
              'https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/app-release.apk',
              false,
              'Yeni versiyon yayÄ±nlandÄ±! GÃ¼ncellemeyi indirin.'
            );
            ```
            
            ### ğŸ“ DeÄŸiÅŸiklikler
            - Yeni Ã¶zellikler ve iyileÅŸtirmeler
            - Hata dÃ¼zeltmeleri
            - Performans optimizasyonlarÄ±
          files: frontend/build/app/outputs/flutter-apk/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Build Success
        run: |
          echo "âœ… APK baÅŸarÄ±yla oluÅŸturuldu ve release'e eklendi!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo "ğŸ“¥ APK Download: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/app-release.apk"

name: Build and Release APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ“± Setup Android SDK 36
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-36" "build-tools;36.0.0" || true

      - name: ğŸ¦ Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ” Configure Supabase Secrets
        working-directory: ./frontend
        run: |
          mkdir -p .dart_tool
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: ğŸ“¦ Get Flutter Dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: ğŸ” Decode Release Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d '\r\n\t ' | base64 --decode > frontend/android/app/upload-keystore.jks
          ls -lh frontend/android/app/upload-keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: ğŸ· Update pubspec.yaml Version
        working-directory: ./frontend
        run: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # KRÄ°TÄ°K: Build number'Ä± HER ZAMAN github.run_number ile gÃ¼ncelle!
          # Bu sayede APK'daki build number ile Supabase'deki build number
          # her zaman eÅŸleÅŸir ve gereksiz gÃ¼ncelleme bildirimi Ã§Ä±kmaz.
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          BUILD_NUMBER="${{ github.run_number }}"
          
          # Tag varsa versiyonu tag'den al, yoksa mevcut versiyonu kullan
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            echo "ğŸ“Œ Tag detected: Using version ${VERSION} from tag"
          else
            # Mevcut versiyonu oku (sadece versiyon kÄ±smÄ±nÄ±, + Ã¶ncesini)
            CURRENT=$(grep "^version:" pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
            VERSION="${CURRENT}"
            echo "ğŸ“Œ No tag: Using existing version ${VERSION}"
          fi
          
          echo "ğŸ“¦ Final version: ${VERSION}+${BUILD_NUMBER}"
          
          # pubspec.yaml'daki version satÄ±rÄ±nÄ± gÃ¼ncelle
          sed -i "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml
          
          # DoÄŸrulama
          echo "âœ… Updated pubspec.yaml:"
          grep "^version:" pubspec.yaml

      - name: ï¿½ğŸ”§ Build APK (Release)
        working-directory: ./frontend
        run: |
          flutter build apk --release \
            --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: ğŸ“¦ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: ğŸ“‹ Get Version Info
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION="1.0.0-${GITHUB_SHA:0:7}"
            TAG="v${VERSION}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION, Tag: $TAG, Build: ${{ github.run_number }}"

      - name: ğŸ·ï¸ Create GitHub Release
        id: release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ Project-Friend ${{ github.ref_name }}
            
            ### ğŸ“¥ Kurulum
            1. APK dosyasÄ±nÄ± indirin
            2. Telefonunuzda "Bilinmeyen Kaynaklardan Kurulum" aktif olmalÄ±
            3. APK'yÄ± kurun
            
            ---
            **Build:** #${{ github.run_number }}
          files: frontend/build/app/outputs/flutter-apk/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # =====================================================
      # ğŸ”„ SUPABASE APP_CONFIG TABLOSUNU GÃœNCELLE
      # HER BUILD'de Ã§alÄ±ÅŸÄ±r - build number senkronizasyonu iÃ§in
      # =====================================================
      - name: ğŸ”„ Update Supabase app_config
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          REPO: ${{ github.repository }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # KRÄ°TÄ°K: Supabase'i HER BUILD'de gÃ¼ncelle!
          # Bu sayede APK'daki build number ile Supabase'deki build number
          # her zaman eÅŸleÅŸir ve gereksiz gÃ¼ncelleme bildirimi Ã§Ä±kmaz.
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Version ve Download URL belirle
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${TAG}/app-release.apk"
            echo "ğŸ“Œ TAG build: Using release URL"
          else
            # Normal push - mevcut versiyonu kullan
            VERSION=$(grep "^version:" frontend/pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
            # Artifact iÃ§in geÃ§ici URL (GitHub Releases yok)
            DOWNLOAD_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
            echo "ğŸ“Œ Normal push: Using actions run URL"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Supabase app_config gÃ¼ncelleniyor..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   Current Version: ${VERSION}"
          echo "   Build Number: ${BUILD_NUMBER}"
          echo "   Download URL: ${DOWNLOAD_URL}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Supabase REST API ile PATCH isteÄŸi
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X PATCH "${SUPABASE_URL}/rest/v1/app_config?id=eq.ea7ba3bf-f1c5-4361-becd-d5e42c62c975" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"current_version\": \"${VERSION}\",
              \"build_number\": ${BUILD_NUMBER},
              \"download_url\": \"${DOWNLOAD_URL}\",
              \"is_force_update\": false
            }")
          
          echo "ğŸ“Š HTTP Status: ${HTTP_STATUS}"
          
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… Supabase app_config baÅŸarÄ±yla gÃ¼ncellendi!"
            echo ""
            echo "ğŸ“± ArtÄ±k uygulama build_number = ${BUILD_NUMBER} bekleyecek"
          else
            echo "âŒ Supabase gÃ¼ncelleme hatasÄ±!"
            cat /tmp/response.txt
            exit 1
          fi
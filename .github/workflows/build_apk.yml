name: Build and Release APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ“± Setup Android SDK 36
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-36" "build-tools;36.0.0" || true

      - name: ğŸ¦ Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ” Configure Supabase Secrets
        working-directory: ./frontend
        run: |
          mkdir -p .dart_tool
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: ğŸ“¦ Get Flutter Dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: ğŸ” Decode Release Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d '\r\n\t ' | base64 --decode > frontend/android/app/upload-keystore.jks
          ls -lh frontend/android/app/upload-keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: ğŸ· Update pubspec.yaml Version
        working-directory: ./frontend
        run: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # KRÄ°TÄ°K: Build number'Ä± HER ZAMAN github.run_number ile gÃ¼ncelle!
          # Bu sayede APK'daki build number ile Supabase'deki build number
          # her zaman eÅŸleÅŸir ve gereksiz gÃ¼ncelleme bildirimi Ã§Ä±kmaz.
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          BUILD_NUMBER="${{ github.run_number }}"
          
          # Tag varsa versiyonu tag'den al, yoksa mevcut versiyonu kullan
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            echo "ğŸ“Œ Tag detected: Using version ${VERSION} from tag"
          else
            # Mevcut versiyonu oku (sadece versiyon kÄ±smÄ±nÄ±, + Ã¶ncesini)
            CURRENT=$(grep "^version:" pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
            VERSION="${CURRENT}"
            echo "ğŸ“Œ No tag: Using existing version ${VERSION}"
          fi
          
          echo "ğŸ“¦ Final version: ${VERSION}+${BUILD_NUMBER}"
          
          # pubspec.yaml'daki version satÄ±rÄ±nÄ± gÃ¼ncelle
          sed -i "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml
          
          # DoÄŸrulama
          echo "âœ… Updated pubspec.yaml:"
          grep "^version:" pubspec.yaml

      - name: ï¿½ğŸ”§ Build APK (Release)
        working-directory: ./frontend
        run: |
          flutter build apk --release \
            --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: ğŸ“¦ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: ğŸ“‹ Get Version Info
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION="1.0.0-${GITHUB_SHA:0:7}"
            TAG="v${VERSION}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION, Tag: $TAG, Build: ${{ github.run_number }}"

      - name: ğŸ·ï¸ Create GitHub Release
        id: release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ Project-Friend ${{ github.ref_name }}
            
            ### ğŸ“¥ Kurulum
            1. APK dosyasÄ±nÄ± indirin
            2. Telefonunuzda "Bilinmeyen Kaynaklardan Kurulum" aktif olmalÄ±
            3. APK'yÄ± kurun
            
            ---
            **Build:** #${{ github.run_number }}
          files: frontend/build/app/outputs/flutter-apk/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # =====================================================
      # ğŸ”„ SUPABASE APP_CONFIG TABLOSUNU GÃœNCELLE
      # HER BUILD'de Ã§alÄ±ÅŸÄ±r - build number senkronizasyonu iÃ§in
      # =====================================================
      - name: ğŸ”„ Update Supabase app_config
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          REPO: ${{ github.repository }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # KRÄ°TÄ°K: Supabase'i HER BUILD'de gÃ¼ncelle!
          # Bu sayede APK'daki build number ile Supabase'deki build number
          # her zaman eÅŸleÅŸir ve gereksiz gÃ¼ncelleme bildirimi Ã§Ä±kmaz.
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Version ve Download URL belirle
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${TAG}/app-release.apk"
            echo "ğŸ“Œ TAG build: Using release URL"
          else
            # Normal push - mevcut versiyonu kullan
            VERSION=$(grep "^version:" frontend/pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
            # Artifact iÃ§in geÃ§ici URL (GitHub Releases yok)
            DOWNLOAD_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
            echo "ğŸ“Œ Normal push: Using actions run URL"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Supabase app_config gÃ¼ncelleniyor..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   Current Version: ${VERSION}"
          echo "   Build Number: ${BUILD_NUMBER}"
          echo "   Download URL: ${DOWNLOAD_URL}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Supabase REST API ile PATCH isteÄŸi
          HTTP_STATUS=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X PATCH "${SUPABASE_URL}/rest/v1/app_config?id=eq.ea7ba3bf-f1c5-4361-becd-d5e42c62c975" \
            -H "apikey: ${SUPABASE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"current_version\": \"${VERSION}\",
              \"build_number\": ${BUILD_NUMBER},
              \"download_url\": \"${DOWNLOAD_URL}\",
              \"is_force_update\": false
            }")
          
          echo "ğŸ“Š HTTP Status: ${HTTP_STATUS}"
          
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… Supabase app_config baÅŸarÄ±yla gÃ¼ncellendi!"
            echo ""
            echo "ğŸ“± ArtÄ±k uygulama build_number = ${BUILD_NUMBER} bekleyecek"
          else
            echo "âŒ Supabase gÃ¼ncelleme hatasÄ±!"
            cat /tmp/response.txt
            exit 1
          fi

      # =====================================================
      # ğŸ”” PUSH NOTIFICATION GÃ–NDER (FCM)
      # TÃ¼m kullanÄ±cÄ±lara gÃ¼ncelleme bildirimi gÃ¶nder
      # =====================================================
      - name: ğŸ”” Send Push Notification via FCM
        if: startsWith(github.ref, 'refs/tags/')
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”” FCM PUSH NOTIFICATION GÃ–NDERÄ°LÄ°YOR..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Service account secret kontrolÃ¼
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
            echo "âš ï¸ FIREBASE_SERVICE_ACCOUNT_KEY secret bulunamadÄ±!"
            echo "   Push notification gÃ¶nderilmedi."
            echo "   GitHub Secrets'a Base64 encoded service account JSON ekleyin."
            exit 0
          fi
          
          # Firebase Service Account JSON'u decode et
          echo "$FIREBASE_SERVICE_ACCOUNT" | base64 --decode > /tmp/firebase_sa.json
          
          if [ ! -s /tmp/firebase_sa.json ]; then
            echo "âš ï¸ Service account decode edilemedi!"
            exit 0
          fi
          
          # Python baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kur
          pip install pyjwt cryptography requests -q
          
          # Python script ile FCM bildirimi gÃ¶nder
          python3 << 'PYTHON_SCRIPT'
          import json
          import time
          import os
          import jwt
          import requests
          
          version = os.environ.get('VERSION', '1.0.0')
          
          # Service account yÃ¼kle
          with open('/tmp/firebase_sa.json') as f:
              sa = json.load(f)
          
          project_id = sa['project_id']
          print(f"ğŸ“¦ Firebase Project: {project_id}")
          
          # JWT oluÅŸtur
          now = int(time.time())
          payload = {
              'iss': sa['client_email'],
              'sub': sa['client_email'],
              'aud': 'https://oauth2.googleapis.com/token',
              'iat': now,
              'exp': now + 3600,
              'scope': 'https://www.googleapis.com/auth/firebase.messaging'
          }
          
          assertion = jwt.encode(payload, sa['private_key'], algorithm='RS256')
          
          # Access token al
          token_response = requests.post('https://oauth2.googleapis.com/token', data={
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'assertion': assertion
          })
          
          if token_response.status_code != 200:
              print(f"âŒ Token alÄ±namadÄ±: {token_response.text}")
              exit(0)
          
          access_token = token_response.json()['access_token']
          print("âœ… Access token alÄ±ndÄ±")
          
          # FCM mesajÄ± gÃ¶nder
          fcm_url = f"https://fcm.googleapis.com/v1/projects/{project_id}/messages:send"
          
          message = {
              "message": {
                  "topic": "all",
                  "notification": {
                      "title": "Yeni GÃ¼ncelleme Mevcut! ğŸš€",
                      "body": f"UygulamanÄ±n en yeni Ã¶zelliklerini kullanmak iÃ§in lÃ¼tfen gÃ¼ncelleyin. (v{version})"
                  },
                  "data": {
                      "type": "app_update",
                      "version": version,
                      "click_action": "FLUTTER_NOTIFICATION_CLICK"
                  },
                  "android": {
                      "priority": "high",
                      "notification": {
                          "channel_id": "high_importance_channel",
                          "sound": "default"
                      }
                  }
              }
          }
          
          fcm_response = requests.post(
              fcm_url,
              headers={
                  'Authorization': f'Bearer {access_token}',
                  'Content-Type': 'application/json'
              },
              json=message
          )
          
          if fcm_response.status_code == 200:
              print("âœ… Push notification baÅŸarÄ±yla gÃ¶nderildi!")
              print("ğŸ“¬ TÃ¼m 'all' topic abonelerine bildirim ulaÅŸtÄ±.")
          else:
              print(f"âš ï¸ Push notification gÃ¶nderilemedi: {fcm_response.text}")
          PYTHON_SCRIPT
          
          # Temizlik
          rm -f /tmp/firebase_sa.json
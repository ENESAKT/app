name: Build and Release APK

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ“± Setup Android SDK 36
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-36" "build-tools;36.0.0" || true

      - name: ğŸ¦ Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ” Configure Supabase Secrets
        working-directory: ./frontend
        run: |
          mkdir -p .dart_tool
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      - name: ğŸ“¦ Get Flutter Dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: ğŸ” Decode Release Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d '\r\n\t ' | base64 --decode > frontend/android/app/upload-keystore.jks
          ls -lh frontend/android/app/upload-keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: ğŸ”§ Build APK (Release)
        working-directory: ./frontend
        run: |
          flutter build apk --release \
            --dart-define=SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            --dart-define=SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: ğŸ“¦ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: ğŸ“‹ Get Version Info
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=${TAG#v}
          else
            VERSION="1.0.0-${GITHUB_SHA:0:7}"
            TAG="v${VERSION}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION, Tag: $TAG"

      - name: ğŸ·ï¸ Create GitHub Release
        id: release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## ğŸš€ Project-Friend v${{ steps.version.outputs.version }}
            
            ### ğŸ“¥ Kurulum
            1. APK dosyasÄ±nÄ± indirin
            2. Telefonunuzda "Bilinmeyen Kaynaklardan Kurulum" aktif olmalÄ±
            3. APK'yÄ± kurun
            
            ---
            **Build:** #${{ github.run_number }}
          files: frontend/build/app/outputs/flutter-apk/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # =====================================================
      # ğŸš€ SUPABASE APP_CONFIG TABLOSUNU GÃœNCELLE
      # Sadece tag pushlandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
      # =====================================================
      - name: ğŸ”„ Update Supabase app_config
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # APK indirme linkini oluÅŸtur
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/app-release.apk"
          
          echo "ğŸ“¦ Supabase app_config gÃ¼ncelleniyor..."
          echo "   Version: ${{ steps.version.outputs.version }}"
          echo "   Build: ${{ github.run_number }}"
          echo "   URL: $DOWNLOAD_URL"
          
          # Supabase REST API ile gÃ¼ncelle (UPSERT)
          # Bu, id=1 olan kaydÄ± gÃ¼nceller veya yoksa oluÅŸturur
          curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/app_config" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d '{
              "id": 1,
              "current_version": "${{ steps.version.outputs.version }}",
              "build_number": ${{ github.run_number }},
              "download_url": "'"$DOWNLOAD_URL"'",
              "is_force_update": false,
              "release_notes": "ğŸš€ v${{ steps.version.outputs.version }} yayÄ±nlandÄ±!\n\nâ€¢ Yeni Ã¶zellikler ve iyileÅŸtirmeler\nâ€¢ Hata dÃ¼zeltmeleri"
            }'
          
          echo "âœ… Supabase app_config gÃ¼ncellendi!"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}